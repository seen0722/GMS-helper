<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CTS Insight</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                        display: ['Outfit', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            100: '#dbeafe',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                        },
                        secondary: '#475569',
                        apple: {
                            blue: '#007AFF',
                            gray: '#8E8E93',
                            bg: '#F2F2F7',
                            card: 'rgba(255, 255, 255, 0.8)',
                        }
                    },
                    boxShadow: {
                        'apple': '0 1px 3px rgba(0, 0, 0, 0.04), 0 8px 30px rgba(0, 0, 0, 0.06)',
                        'apple-hover': '0 2px 6px rgba(0, 0, 0, 0.06), 0 20px 40px rgba(0, 0, 0, 0.10)',
                        'apple-elevated': '0 4px 12px rgba(0, 0, 0, 0.08), 0 24px 48px rgba(0, 0, 0, 0.12)',
                    },
                    spacing: {
                        '18': '4.5rem',
                        '22': '5.5rem',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        :root {
            --apple-blur: blur(20px);
        }

        body {
            font-feature-settings: "cv02", "cv03", "cv04", "cv11";
            -webkit-font-smoothing: antialiased;
        }

        .glass {
            background: rgba(255, 255, 255, 0.7) !important;
            backdrop-filter: var(--apple-blur);
            -webkit-backdrop-filter: var(--apple-blur);
        }

        .glass-dark {
            background: rgba(15, 23, 42, 0.8) !important;
            backdrop-filter: var(--apple-blur);
            -webkit-backdrop-filter: var(--apple-blur);
        }

        .nav-item-active {
            background: rgba(59, 130, 246, 0.1) !important;
            color: #3b82f6 !important;
            font-weight: 500;
        }

        /* Apple-style Segmented Control */
        .segmented-control {
            background: rgba(118, 118, 128, 0.12);
            padding: 2px;
            border-radius: 9px;
            display: inline-flex;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.06);
        }
        
        .segmented-item {
            padding: 6px 16px;
            border-radius: 7px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            user-select: none;
        }

        .segmented-item:active {
            transform: scale(0.97);
        }

        .segmented-item.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 2px 6px rgba(0,0,0,0.08);
        }

        /* iOS-style Toggle Switch */
        .ios-toggle {
            position: relative;
            width: 51px;
            height: 31px;
            background: #E9E9EA;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: background 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 0;
            flex-shrink: 0;
        }

        .ios-toggle[aria-checked="true"] {
            background: #34C759;
        }

        .ios-toggle-dot {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 27px;
            height: 27px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ios-toggle[aria-checked="true"] .ios-toggle-dot {
            transform: translateX(20px);
        }

        .ios-toggle:active .ios-toggle-dot {
            width: 31px;
        }

        .ios-toggle[aria-checked="true"]:active .ios-toggle-dot {
            transform: translateX(16px);
        }

        /* Custom scrollbar for code blocks */
        .code-scroll::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .code-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .code-scroll::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .code-scroll::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* LLM Status Badge */
        .llm-badge {
            @apply flex items-center gap-2 px-3 py-1.5 bg-slate-50 rounded-full border border-slate-200 transition-all duration-300;
        }
        
        .llm-badge:hover {
            @apply bg-white shadow-sm border-slate-300 scale-[1.02];
        }

        /* Skeleton Loading Animation */
        @keyframes skeleton-shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Slide Down Animation for Warnings */
        @keyframes slideDown {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .skeleton {
            background: linear-gradient(
                90deg,
                #f1f5f9 0%,
                #e2e8f0 20%,
                #f1f5f9 40%,
                #f1f5f9 100%
            );
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: 8px;
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5em;
        }

        .skeleton-text-sm {
            height: 0.75em;
            width: 60%;
        }

        .skeleton-stat {
            height: 2.25rem;
            width: 4rem;
        }

        .skeleton-sparkline {
            height: 2.5rem;
            width: 6rem;
        }

        .skeleton-row {
            height: 4rem;
        }

        .skeleton-circle {
            border-radius: 9999px;
        }

        /* Utility: Hide Scrollbar but keep functionality */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;  /* Chrome, Safari and Opera */
        }

        /* Page Transition Animations */
        @keyframes page-fade-in {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes page-fade-out {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-8px);
            }
        }

        .page-enter {
            animation: page-fade-in 0.3s ease-out forwards;
        }

        .page-exit {
            animation: page-fade-out 0.15s ease-in forwards;
        }

        /* Button Press States */
        .btn-press {
            transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-press:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.12);
        }

        .btn-press:active {
            transform: scale(0.97);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Primary Button Enhanced */
        .btn-primary {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-primary:hover {
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: scale(0.98) translateY(0);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.2);
        }

        /* Success Checkmark Animation */
        @keyframes checkmark-draw {
            0% { stroke-dashoffset: 24; }
            100% { stroke-dashoffset: 0; }
        }

        @keyframes success-pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }

        .success-checkmark {
            stroke-dasharray: 24;
            stroke-dashoffset: 24;
            animation: checkmark-draw 0.4s ease-out forwards, success-pulse 0.6s ease-in-out 0.4s;
        }

        .success-icon {
            animation: success-pulse 0.6s ease-in-out;
        }

        /* Enhanced Focus Rings (Apple HIG) */
        input:focus, select:focus, button:focus-visible, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35), 0 0 0 1px rgba(59, 130, 246, 0.5);
        }

        .segmented-item:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.35);
        }

        /* Details/Summary Expand Animation */
        details {
            overflow: hidden;
        }

        details[open] > div {
            animation: slide-down 0.3s ease-out;
        }

        @keyframes slide-down {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Hover Elevation */
        .card-hover {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06), 0 20px 40px rgba(0, 0, 0, 0.10);
        }

        /* Stat Number Typography */
        .stat-number {
            font-feature-settings: "tnum";
            letter-spacing: -0.02em;
        }

        /* Modal Backdrop Blur */
        .modal-backdrop {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* Toast HUD Style */
        .toast-hud {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Submission Card Gradients */
        .status-gradient-draft { background: linear-gradient(90deg, #94a3b8, #cbd5e1); }
        .status-gradient-analyzing { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .status-gradient-ready { background: linear-gradient(90deg, #10b981, #34d399); }
        .status-gradient-published { background: linear-gradient(90deg, #3b82f6, #60a5fa); }

        /* Suite Card Styles */
        .suite-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .suite-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .suite-pass { background: rgba(16, 185, 129, 0.08); border: 2px solid rgba(16, 185, 129, 0.3); }
        .suite-fail { background: rgba(239, 68, 68, 0.08); border: 2px solid rgba(239, 68, 68, 0.3); }
        .suite-missing { background: #f8fafc; border: 2px dashed #cbd5e1; }
        .suite-analyzing { background: rgba(245, 158, 11, 0.08); border: 2px solid rgba(245, 158, 11, 0.3); }

        /* Submission Card */
        .submission-card {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }

        .submission-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

    </style>
</head>

<body class="bg-slate-50 text-slate-900 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-72 glass-dark text-white flex-shrink-0 flex flex-col border-r border-slate-800/50 z-20">
        <div class="p-8">
            <h1 class="text-2xl font-display font-bold flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <span class="tracking-tight">CTS Insight</span>
            </h1>
        </div>
        <nav class="flex-1 px-4 space-y-1.5">
            <a href="#" onclick="router.navigate('dashboard')"
                class="nav-item group flex items-center gap-3 px-4 py-2.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all duration-200" id="nav-dashboard">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                Dashboard
            </a>
            <a href="#" onclick="router.navigate('submissions')"
                class="nav-item group flex items-center gap-3 px-4 py-2.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all duration-200" id="nav-submissions">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                </svg>
                Submissions
            </a>
            <a href="#" onclick="router.navigate('upload')"
                class="nav-item group flex items-center gap-3 px-4 py-2.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all duration-200" id="nav-upload">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                Upload Result
            </a>
            <a href="#" onclick="router.navigate('settings')"
                class="nav-item group flex items-center gap-3 px-4 py-2.5 rounded-xl text-slate-400 hover:text-white hover:bg-white/5 transition-all duration-200" id="nav-settings">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Settings
            </a>
        </nav>
        
        <!-- Projects / Products Section -->
        <div class="px-6 mt-6 mb-2">
            <h3 class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Projects</h3>
        </div>
        <nav class="px-4 space-y-1.5 overflow-y-auto flex-1 custom-scrollbar" id="sidebar-products">
            <!-- Product items injected by JS -->
             <div class="px-4 py-2 text-xs text-slate-500 italic">Loading...</div>
        </nav>
        <div class="p-4 border-t border-slate-800">
            <button id="btn-reset" type="button"
                class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-red-900/30 text-red-400 hover:bg-red-900/50 rounded transition-colors text-sm font-medium">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Reset Data
            </button>
            <div class="mt-4 text-xs text-slate-500 text-center">v1.0.1</div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden bg-[#F8FAFC]">
        <!-- Header -->
        <header class="glass sticky top-0 z-10 border-b border-slate-200/50 px-8 py-4 flex justify-between items-center">
            <h2 id="page-title" class="text-xl font-display font-bold text-slate-900">Dashboard</h2>
            <div class="flex items-center gap-4">
                <!-- LLM Status Badge Container -->
                <div id="llm-status-badge" class="hidden llm-badge">
                    <span class="llm-badge-icon w-1.5 h-1.5 rounded-full flex-shrink-0 transition-all duration-300 bg-blue-500 shadow-[0_0_8px_rgba(59,130,246,0.5)]"></span>
                    <div class="flex flex-col leading-none">
                        <span id="llm-provider-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">AI Provider</span>
                        <span id="llm-model-text" class="text-xs font-semibold text-slate-700">Loading...</span>
                    </div>
                </div>

                <div class="flex items-center gap-2 px-3 py-1.5 bg-green-50 rounded-full border border-green-100">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span class="text-xs font-semibold text-green-700">System Ready</span>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <div id="app-content" class="flex-1 overflow-auto p-6">
            <!-- Dynamic Content Loaded Here -->
        </div>
    </main>

    <!-- Global Delete Confirmation Modal (accessible from all pages) -->
    <div id="delete-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 animate-in fade-in duration-200">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl animate-in zoom-in-95 duration-200">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Confirm Deletion</h3>
            <div id="delete-modal-message" class="text-sm text-slate-600 mb-6"></div>
            <div class="flex gap-3 justify-end">
                <button id="modal-cancel"
                    class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl hover:bg-slate-200 transition-colors font-medium">
                    Cancel
                </button>
                <button id="modal-confirm"
                    class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-colors font-medium">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Global Alert Modal -->
    <div id="alert-modal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 animate-in fade-in duration-200">
        <div class="bg-white rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl animate-in zoom-in-95 duration-200 border border-slate-100">
            <div class="flex items-center gap-3 mb-4 text-amber-500">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                <h3 class="text-lg font-bold text-slate-800">Notice</h3>
            </div>
            <div id="alert-modal-message" class="text-sm text-slate-600 mb-6 font-medium leading-relaxed"></div>
            <div class="flex justify-end">
                <button id="alert-modal-ok"
                    class="px-6 py-2 bg-slate-900 text-white rounded-xl hover:bg-slate-800 transition-colors font-bold shadow-lg shadow-slate-900/20">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Templates -->
    <template id="tmpl-dashboard">
        <div class="space-y-5 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Stats Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-2xl shadow-apple border border-slate-100 card-hover overflow-hidden relative">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 bg-blue-50 text-blue-600 rounded-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                        </div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Runs</div>
                    </div>
                    <div class="flex items-end justify-between">
                        <div class="text-3xl font-display font-bold text-slate-900" id="stat-total-runs">-</div>
                        <div class="w-24 h-10" id="stat-total-runs-sparkline"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-apple border border-slate-100 card-hover overflow-hidden relative">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 bg-emerald-50 text-emerald-600 rounded-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">Avg Pass Rate</div>
                    </div>
                    <div class="flex items-end justify-between">
                        <div class="text-3xl font-display font-bold text-emerald-600" id="stat-avg-pass">-</div>
                        <div class="w-24 h-10" id="stat-avg-pass-sparkline"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-apple border border-slate-100 card-hover overflow-hidden relative">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 bg-red-50 text-red-600 rounded-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                        </div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Failures</div>
                    </div>
                    <div class="flex items-end justify-between">
                        <div class="text-3xl font-display font-bold text-red-600" id="stat-total-failures">-</div>
                        <div class="w-24 h-10" id="stat-total-failures-sparkline"></div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-apple border border-slate-100 card-hover overflow-hidden relative">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 bg-purple-50 text-purple-600 rounded-xl">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 012-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v4M14 12v1m0 4v1m-4-5v1m0 4v1" /></svg>
                        </div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest">Total Clusters</div>
                    </div>
                    <div class="flex items-end justify-between">
                        <div class="text-3xl font-display font-bold text-purple-600" id="stat-total-clusters">-</div>
                        <div class="w-24 h-10" id="stat-total-clusters-sparkline"></div>
                    </div>
                </div>
            </div>

            <!-- Recent Runs Table -->
            <div class="bg-white rounded-2xl shadow-apple border border-slate-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <h3 class="text-base font-display font-bold text-slate-900">Recent Test Runs</h3>
                        <button onclick="router.navigate('upload')"
                            class="text-sm bg-primary-600 text-white px-4 py-2 rounded-xl hover:bg-primary-700 transition-all shadow-md shadow-primary-600/20 font-semibold btn-press">
                            New Upload
                        </button>
                    </div>
                    <div class="flex gap-4">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input type="text" id="runs-search" placeholder="Search suite, device, or ID..."
                                class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all outline-none">
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50/50 text-slate-500 font-bold uppercase tracking-wider text-[10px]">
                            <tr>
                                <th class="px-8 py-4">ID</th>
                                <th class="px-8 py-4">Suite</th>
                                <th class="px-8 py-4">Device</th>
                                <th class="px-8 py-4">Date</th>
                                <th class="px-8 py-4 text-center">Pass Rate</th>
                                <th class="px-8 py-4 text-center">Result</th>
                                <th class="px-8 py-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="runs-table-body" class="divide-y divide-slate-100">
                            <!-- Rows injected via JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div class="px-8 py-5 border-t border-slate-100 flex items-center justify-between bg-slate-50/30">
                    <div class="text-xs font-medium text-slate-400">
                        Displaying <span id="runs-start" class="text-slate-600">0</span> â€“ <span id="runs-end" class="text-slate-600">0</span> of <span id="runs-total" class="text-slate-600">0</span>
                    </div>
                    <div class="flex gap-3">
                        <button id="runs-prev" disabled
                            class="px-4 py-2 border border-slate-200 rounded-lg text-xs font-bold disabled:opacity-30 disabled:cursor-not-allowed hover:bg-white transition-all">
                            Previous
                        </button>
                        <button id="runs-next" disabled
                            class="px-4 py-2 border border-slate-200 rounded-lg text-xs font-bold disabled:opacity-30 disabled:cursor-not-allowed hover:bg-white transition-all">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="tmpl-upload">
        <div class="max-w-xl mx-auto mt-20 animate-in zoom-in-95 fade-in duration-500">
            <div class="bg-white p-12 rounded-3xl shadow-apple border border-slate-100 text-center relative overflow-hidden">
                <!-- Decorative background -->
                <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-400 to-indigo-500"></div>
                
                <div class="mb-10">
                    <div class="w-20 h-20 bg-primary-50 text-primary-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-sm border border-primary-100">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-display font-bold text-slate-900">Upload Test Result</h3>
                    <p class="text-slate-500 mt-3 font-medium">Drag and drop your XML file here, or click to browse</p>
                </div>

                <input type="file" id="file-input" class="hidden" accept=".xml">
                <label for="file-input"
                    class="cursor-pointer inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-medium">
                    Select File
                </label>

                <div id="upload-status" class="mt-6 hidden">
                    <div class="w-full bg-slate-100 rounded-full h-2.5 mb-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%" id="upload-progress"></div>
                    </div>
                    <p class="text-sm text-slate-600" id="upload-message">Uploading...</p>
                </div>
            </div>
        </div>
    </template>

    <!-- Submissions List Template -->
    <template id="tmpl-submissions">
        <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Page Header with Action -->
            <!-- Header removed -->

            <!-- Submission Cards Grid -->
            <div id="submissions-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6">
                <!-- Cards injected via JS -->
            </div>

            <!-- Pagination Controls -->
            <div id="submissions-pagination" class="mt-8 flex justify-center"></div>

            <!-- Empty State -->
            <div id="submissions-empty" class="hidden text-center py-20">
                <div class="w-24 h-24 bg-slate-50 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-sm">
                    <svg class="w-12 h-12 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                </div>
                <h3 class="text-lg font-bold text-slate-700">No Submissions Yet</h3>
                <p class="text-slate-500 mt-2">After uploading test results, the system will automatically create a Submission based on Fingerprint</p>
                <button onclick="router.navigate('upload')" 
                    class="mt-6 bg-indigo-600 text-white px-5 py-2.5 rounded-xl font-bold hover:bg-indigo-700 transition-all">
                    Upload Test Result
                </button>
            </div>
        </div>
    </template>

    <!-- Submission Detail Template -->
    <template id="tmpl-submission-detail">
        <div class="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Back Navigation -->
            <button onclick="router.navigate('submissions')" 
                class="flex items-center gap-2 text-slate-500 hover:text-slate-700 transition-colors text-sm font-medium">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Back to Submissions
            </button>

            <!-- Header Card (Frosted Glass) -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 relative transition-all duration-300">
                <div id="submission-status-bar" class="absolute top-0 left-0 w-full h-1.5 rounded-t-2xl bg-gradient-to-r from-slate-400 to-slate-500"></div>
                
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            <h1 id="submission-name" class="text-2xl font-display font-bold text-slate-900">Loading...</h1>
                            <button id="btn-edit-submission" class="p-1 text-slate-400 hover:text-indigo-600 hover:bg-slate-100 rounded-lg transition-colors" title="Rename Submission">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                </svg>
                            </button>
                            <div class="h-6 w-px bg-slate-200 mx-1"></div>
                            <span id="submission-status-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase bg-slate-100 text-slate-600">-</span>
                        </div>
                        <div class="flex items-center gap-4 text-sm text-slate-500">
                                <code id="submission-fingerprint" class="text-xs text-slate-600 bg-slate-50 px-2 py-0.5 rounded border border-slate-200 font-mono select-all">-</code>
                                <button onclick="copyFingerprint()" class="text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-md hover:bg-slate-100/50" title="Copy Fingerprint">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                    </svg>
                                </button>
                            </span>
                            <span class="flex items-center gap-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                                <span id="submission-date">-</span>
                            </span>
                        </div>
                    </div>
                    
                        <!-- Lock Toggle (Apple Switch) -->
                        <div class="flex items-center gap-3 mr-2">
                            <div class="flex flex-col items-end">
                                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider transition-colors duration-300" id="lock-label">Active</span>
                                <span class="text-[9px] text-slate-400 font-medium transition-colors duration-300" id="lock-helper-text">Accepting Reruns</span>
                            </div>
                            
                            <div class="relative group">
                                <button id="btn-lock-toggle" onclick="toggleSubmissionLock(currentSubmissionId)" class="ios-toggle" role="switch" aria-checked="false">
                                    <span class="ios-toggle-dot"></span>
                                </button>
                                
                                <!-- Tooltip -->
                                <div class="absolute top-full right-0 mt-3 w-64 p-4 bg-slate-900 text-white text-xs rounded-xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 pointer-events-none">
                                    <div class="font-bold text-sm mb-1 text-slate-200">Session Locking</div>
                                    <div class="space-y-2">
                                        <div class="flex gap-2">
                                            <div class="w-1.5 h-1.5 rounded-full bg-slate-500 mt-1.5 flex-shrink-0"></div>
                                            <div><strong class="text-slate-300">Active (Unlocked):</strong> Auto-merges new uploads from this device (fixing failures).</div>
                                        </div>
                                        <div class="flex gap-2">
                                            <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 mt-1.5 flex-shrink-0"></div>
                                            <div><strong class="text-emerald-300">Locked:</strong> Freezes this submission. Next upload will create a fresh Phase.</div>
                                        </div>
                                    </div>
                                    <div class="absolute -top-1 right-4 w-2 h-2 bg-slate-900 transform rotate-45"></div>
                                </div>
                            </div>
                        </div>

                        <div class="w-px h-6 bg-slate-200 mx-1"></div>
                        
                        <!-- Export Button -->
                        <button onclick="exportSubmission(currentSubmissionId)" 
                            class="p-2 text-slate-400 hover:text-emerald-600 hover:bg-emerald-50 rounded-lg transition-all"
                            title="Export Excel">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                        </button>
                        
                        <div class="relative group">
                            <button class="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all" title="More Actions">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg>
                            </button>
                            <!-- Dropdown Menu -->
                            <!-- Dropdown Menu -->
                            <div class="absolute right-0 top-full pt-2 w-48 hidden group-hover:block z-50">
                                <div class="bg-white rounded-xl shadow-apple-elevated border border-slate-100 p-1">
                                    <button onclick="enableMoveRunsMode()" class="w-full text-left px-4 py-2 text-sm text-slate-700 hover:bg-slate-50 hover:text-blue-600 rounded-lg flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/></svg>
                                        Split / Move Runs
                                    </button>
                                    <button onclick="confirmDelete(currentSubmissionId)" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                        Delete Submission
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intelligence Warnings (Phase 3) -->
            <div id="submission-warnings" class="hidden space-y-2 transition-all duration-500 ease-in-out">
                <!-- Warning items injected via JS -->
            </div>


            <!-- Compliance Matrix (Persistent Header) -->
            <div class="bg-white rounded-2xl shadow-apple border border-slate-100 overflow-hidden mb-6">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-900">Compliance Matrix</h3>
                    <button onclick="router.navigate('upload')" 
                        class="text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-xl font-medium transition-all flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add Test Result
                    </button>
                </div>
                
                <!-- Matrix Grid -->
                <div id="compliance-matrix" class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Suite Cards injected via JS -->
                </div>
            </div>


            <!-- Tab Navigation (Segmented Control) -->
            <div class="flex justify-center mb-6">
                <div class="segmented-control p-1">
                    <button onclick="switchSubmissionTab('consolidated')" id="sub-tab-btn-consolidated"
                        class="segmented-item px-8 py-2 active">
                        Consolidated Report
                    </button>
                     <button onclick="switchSubmissionTab('analysis')" id="sub-tab-btn-analysis"
                        class="segmented-item px-8 py-2">
                        AI Analysis
                    </button>
                    <button onclick="switchSubmissionTab('runs')" id="sub-tab-btn-runs"
                        class="segmented-item px-8 py-2">
                        Test Runs
                    </button>
                </div>
            </div>

            <!-- Tab: AI Analysis -->
            <div id="sub-tab-analysis" class="hidden space-y-6">
                
                <!-- AI Empty State (Not Analyzed) -->
                <div id="submission-analysis-empty" class="bg-white rounded-2xl shadow-apple border border-slate-100 p-12 text-center">
                    <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-bold text-slate-900 mb-2">Analyze Submission Quality</h3>
                    <p class="text-slate-500 mb-6 max-w-md mx-auto">
                        Generate a comprehensive AI report for this submission. The AI will filter out recovered failures, analyze persistent issues, and provide a strategic executive summary.
                    </p>
                    <button onclick="triggerSubmissionAnalysis(currentSubmissionId)" class="btn-primary bg-indigo-600 text-white px-6 py-2.5 rounded-full shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all font-semibold flex items-center gap-2 mx-auto">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        Run AI Analysis
                    </button>
                    <p class="text-xs text-slate-400 mt-4">Powered by configured LLM Provider</p>
                </div>

                <!-- AI Loaded Content -->
                <div id="submission-analysis-content" class="hidden space-y-6">
                    <!-- Top KPI Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Severity Score -->
                        <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100 relative overflow-hidden group">
                            <div class="absolute top-0 right-0 w-24 h-24 bg-gradient-to-br from-indigo-50 to-purple-50 rounded-bl-full -mr-4 -mt-4 opacity-50 group-hover:scale-110 transition-transform"></div>
                            <div class="relative z-10">
                                <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Quality Severity</div>
                                <div class="flex items-baseline gap-2">
                                    <div class="text-4xl font-display font-bold text-slate-900" id="sub-kpi-severity">-</div>
                                    <div class="text-sm font-medium text-slate-400">/ 100</div>
                                </div>
                                <div class="mt-3 h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                     <div id="sub-kpi-severity-bar" class="h-full bg-indigo-500 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                                <div class="mt-2 text-xs font-medium text-slate-500" id="sub-kpi-severity-label">Calculating...</div>
                            </div>
                        </div>

                        <!-- Executive Summary -->
                        <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100 md:col-span-2 relative">
                             <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-3">Executive Summary</div>
                             <p id="sub-ai-summary" class="text-slate-700 leading-relaxed text-sm font-medium">
                                 Loading summary...
                             </p>
                             <div class="absolute top-4 right-4 text-slate-200">
                                 <svg class="w-12 h-12 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                             </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Top Risks -->
                        <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="p-1.5 rounded-lg bg-red-50 text-red-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                </span>
                                <h3 class="font-bold text-slate-900">Top Technical Risks</h3>
                            </div>
                            <ul id="sub-ai-risks" class="space-y-3">
                                <!-- Injected -->
                            </ul>
                        </div>

                        <!-- Recommendations -->
                        <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                            <div class="flex items-center gap-2 mb-4">
                                <span class="p-1.5 rounded-lg bg-emerald-50 text-emerald-500">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                </span>
                                <h3 class="font-bold text-slate-900">Strategic Recommendations</h3>
                            </div>
                            <ul id="sub-ai-recommendations" class="space-y-3">
                                <!-- Injected -->
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Re-run Button -->
                    <div class="text-right">
                         <button onclick="triggerSubmissionAnalysis(currentSubmissionId)" class="text-xs text-slate-400 hover:text-indigo-600 transition-colors">
                             Re-run Analysis
                         </button>
                    </div>
                </div>
            </div>

            <!-- Tab: Consolidated Report -->
            <div id="sub-tab-consolidated" class="space-y-6">
                <!-- Consolidated Matrix -->
                <div class="bg-white rounded-2xl shadow-apple border border-slate-100 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <h3 class="font-bold text-slate-900">Failure Matrix</h3>
                            <div class="text-xs font-medium text-slate-500 bg-slate-50 px-2 py-1 rounded border border-slate-200">
                                Showing unique failures across all runs
                            </div>
                        </div>
                        
                        <!-- Filters -->
                        <div class="flex bg-slate-100 p-0.5 rounded-lg">
                            <button onclick="filterConsolidated('all')" id="filter-btn-all" class="px-3 py-1 text-xs font-medium rounded-md transition-all text-slate-600 hover:text-slate-900">All</button>
                            <button onclick="filterConsolidated('persistent')" id="filter-btn-persistent" class="px-3 py-1 text-xs font-bold rounded-md bg-white shadow-sm text-red-600 transition-all">Persistent</button>
                            <button onclick="filterConsolidated('recovered')" id="filter-btn-recovered" class="px-3 py-1 text-xs font-medium rounded-md transition-all text-emerald-600 hover:text-emerald-700">Recovered</button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50/50 text-slate-500 font-bold uppercase tracking-wider text-[10px]">
                                <tr>
                                    <th class="px-6 py-3 w-1/3">Test Case</th>
                                    <!-- Dynamic Run Columns will be injected here -->
                                    <th id="header-matrix-runs"></th> 
                                    <th class="px-6 py-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="consolidated-tbody" class="divide-y divide-slate-100">
                                <!-- JS Injection -->
                            </tbody>
                        </table>
                    </div>
                     <div id="consolidated-empty" class="hidden px-6 py-12 text-center text-slate-400">
                        <p>No failures found in this submission! ðŸŽ‰</p>
                    </div>
                </div>
            </div>

            <!-- Tab: Test Runs (Existing Content Wrapped) -->
            <div id="sub-tab-runs" class="hidden space-y-6">


            <!-- Test Runs List -->
            <div class="bg-white rounded-2xl shadow-apple border border-slate-100 overflow-hidden">
                <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-900">Test Runs</h3>
                    <div class="flex gap-2">
                         <button id="btn-select-runs" onclick="toggleRunSelectionMode()" 
                            class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1.5 rounded-lg font-medium transition-all">
                            Select Runs
                        </button>
                        <button id="btn-move-runs" onclick="openMoveRunsModal()" 
                            class="hidden text-xs bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1.5 rounded-lg font-medium transition-all shadow-sm shadow-indigo-200">
                            Move Selected
                        </button>
                    </div>
                </div>
                <div id="submission-runs-list" class="divide-y divide-slate-100">
                    <!-- Run rows injected via JS -->
                </div>
                <div id="submission-runs-empty" class="hidden px-6 py-8 text-center text-slate-400">
                    No test runs yet
                </div>
            </div>
        </div>
    </template>

    <template id="tmpl-run-details">
        <div class="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Back Navigation -->
            <button id="btn-run-back" onclick="router.navigate('submissions')" 
                class="flex items-center gap-2 text-slate-500 hover:text-slate-700 transition-colors text-sm font-medium">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                <span>Back</span>
            </button>

            <!-- Header Info (Compact) -->
            <div class="bg-white px-6 py-4 rounded-2xl shadow-apple border border-slate-100 flex justify-between items-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-primary-500" id="detail-header-bar"></div>
                <div class="flex items-center gap-6">
                    <div>
                        <div class="flex items-center gap-3">
                            <h3 class="text-xl font-display font-bold text-slate-900 flex items-center gap-2" id="detail-suite-name">CTS</h3>
                            <button id="btn-view-submission" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full border border-indigo-100 font-semibold hover:bg-indigo-100 transition-colors flex items-center gap-1 group">
                                <span id="detail-submission-name">View Submission</span>
                                <svg class="w-3 h-3 group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            </button>
                        </div>
                        <div id="detail-device" class="mt-1"></div>
                    </div>
                    <p class="text-xs text-slate-400" id="detail-date">-</p>
                </div>
                <div class="text-right">
                    <div class="text-2xl font-display font-bold text-slate-900" id="detail-pass-rate">0%</div>
                    <div class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">Pass Rate</div>
                </div>
            </div>
 
            <!-- Tab Navigation (Segmented Control) -->
            <div class="flex justify-center">
                <div class="segmented-control p-1">
                    <button onclick="switchTab('overview')" id="tab-btn-overview"
                        class="tab-btn segmented-item px-8 py-2 active">
                        Overview
                    </button>
                    <button onclick="switchTab('analysis')" id="tab-btn-analysis"
                        class="tab-btn segmented-item px-8 py-2">
                        AI Analysis
                    </button>
                    <button onclick="switchTab('failures')" id="tab-btn-failures"
                        class="tab-btn segmented-item px-8 py-2">
                        Test Failures
                    </button>
                </div>
            </div>

            <!-- Tab Content: Overview -->
            <div id="tab-overview" class="tab-content space-y-6">
                <!-- System Info Placeholder -->
                <div id="system-info-container"></div>

                <!-- Test Statistics Placeholder -->
                <div id="test-stats-container"></div>

                <!-- Actions -->

            </div>

            <!-- Tab Content: Analysis -->
            <div id="tab-analysis" class="tab-content hidden space-y-8">
 
                <!-- Layer 1: AI-Driven Quality Summary -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <!-- AI Predicted Severity -->
                    <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">AI Severity</div>
                        <div class="text-2xl font-display font-bold text-slate-900" id="kpi-severity">-</div>
                        <div class="text-xs text-slate-400 mt-2 font-medium">Predictive insight</div>
                    </div>
                    <!-- Root Cause Distribution -->
                    <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Main Category</div>
                        <div class="text-2xl font-display font-bold text-slate-900" id="kpi-top-category">-</div>
                        <div class="text-xs text-slate-400 mt-2 font-medium" id="kpi-category-dist">-</div>
                    </div>
                    <!-- To-Do List -->
                    <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">To-Do Items</div>
                        <div class="text-2xl font-display font-bold text-red-500" id="kpi-todo-count">-</div>
                        <div class="text-xs text-slate-400 mt-2 font-medium">High priority fixes</div>
                    </div>
                    <!-- Stability Tracker -->
                    <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                        <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Stability</div>
                        <div class="text-2xl font-display font-bold text-emerald-500">Stable</div>
                        <div class="text-xs text-slate-400 mt-2 font-medium">Pattern baseline</div>
                    </div>
                </div>

                <!-- Layer 2: AI Cluster & Action List -->
                <div class="bg-white rounded-2xl shadow-apple border border-slate-100 overflow-hidden mt-8">
                    <div class="px-6 py-4 border-b border-slate-100 bg-white flex justify-between items-center transition-all">
                        <div class="flex items-center gap-4">
                            <h4 class="font-bold text-slate-900 tracking-tight">AI Cluster & Action List</h4>
                        </div>

                        <div class="flex items-center gap-6">
                            <!-- View Mode Toggle (PRD Phase 5) -->
                            <div class="inline-flex rounded-lg bg-slate-100 p-0.5" role="group">
                                <button type="button" id="view-mode-cluster" onclick="switchViewMode('cluster')"
                                    class="px-3 py-1.5 text-xs font-bold rounded-md transition-all duration-200 bg-white text-slate-800 shadow-sm">
                                    Cluster View
                                </button>
                                <button type="button" id="view-mode-module" onclick="switchViewMode('module')"
                                    class="px-3 py-1.5 text-xs font-bold rounded-md transition-all duration-200 text-slate-500 hover:text-slate-700">
                                    Module View
                                </button>
                            </div>

                            <div class="h-6 w-px bg-slate-200"></div>

                            <!-- Toggle for Filtering -->
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Unsynced only</span>
                                <button type="button" id="toggle-no-redmine" class="ios-toggle" role="switch" aria-checked="false" onclick="toggleFilter(this)">
                                    <span class="ios-toggle-dot"></span>
                                </button>
                                <!-- Hidden original checkbox for logic compatibility -->
                                <input type="checkbox" id="filter-no-redmine" class="hidden">
                            </div>

                            <div class="h-6 w-px bg-slate-200"></div>

                            <!-- Action Group -->
                            <div class="flex items-center bg-slate-100 rounded-lg p-1">
                                <button onclick="exportRunReport()"
                                    class="text-slate-600 hover:bg-white hover:text-slate-900 hover:shadow-sm px-3 py-1.5 rounded-md flex items-center gap-1.5 text-xs font-bold transition-all">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Export
                                </button>
                                <button id="btn-bulk-create-issues" onclick="openBulkCreateModal()"
                                    class="hidden text-blue-600 hover:bg-white hover:shadow-sm px-3 py-1.5 rounded-md flex items-center gap-1.5 text-xs font-bold transition-all border-l border-slate-200 ml-1 pl-3">
                                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                        </path>
                                    </svg>
                                    Sync All
                                </button>
                            </div>

                            <!-- Analyze Button (Primary) -->
                            <button id="btn-analyze"
                                class="btn-primary bg-indigo-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 text-xs font-bold ring-offset-2">
                                <svg class="w-4 h-4 text-white/80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5"
                                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Analyze
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                                <tr>
                                    <th class="px-4 py-3">Summary</th>
                                    <th class="px-4 py-3 w-24">Impact</th>
                                    <th class="px-4 py-3 w-32">Confidence</th>
                                    <th class="px-4 py-3 w-28">AI Suggestion</th>
                                    <th class="px-4 py-3 w-28">Owner</th>
                                    <th class="px-4 py-3 w-32">Redmine</th>
                                    <th class="px-4 py-3 w-24">Action</th>
                                </tr>
                            </thead>
                            <tbody id="clusters-table-body" class="divide-y divide-slate-100">
                                <!-- Rows injected via JS -->
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center text-slate-500">
                                        No analysis data found. Click "Run AI Analysis" to start.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Layer 3: Deep Analysis & Fix Suggestion -->
                <div id="analysis-detail-view"
                    class="hidden bg-white rounded-2xl shadow-apple border border-slate-100 overflow-hidden">
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white flex justify-between items-center">
                        <h4 class="font-bold text-slate-900 text-lg" id="detail-title">Cluster Analysis</h4>
                        <div class="flex items-center gap-3">
                            <button onclick="openRedmineModal()" id="btn-assign-redmine"
                                class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-xl transition-all flex items-center gap-2 shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                Assign to Redmine
                            </button>
                    <span id="btn-unlink-redmine-detail" class="hidden">
                        <button onclick="unlinkCluster()" 
                                class="flex items-center gap-1.5 px-3 py-1.5 text-red-600 bg-red-50 hover:bg-red-100 border border-red-200 text-xs font-semibold rounded-lg transition-all shadow-sm hover:shadow">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            <span id="btn-unlink-redmine-text">Unlink</span>
                        </button>
                    </span>
                            <button onclick="document.getElementById('analysis-detail-view').classList.add('hidden')"
                                class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-100 rounded-lg transition-all">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="p-5 space-y-4">
                        <!-- AI Summary -->
                        <div id="detail-summary-body"
                            class="text-slate-700 text-[13px] leading-relaxed bg-blue-50/50 p-4 rounded-xl border border-blue-100">
                        </div>

                        <!-- Root Cause & Fix - Side by Side -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- Root Cause -->
                            <div class="bg-gradient-to-br from-purple-50 to-purple-50/30 p-4 rounded-xl border border-purple-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-6 h-6 rounded-md bg-purple-100 flex items-center justify-center">
                                        <svg class="w-3.5 h-3.5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                        </svg>
                                    </div>
                                    <h5 class="text-xs font-bold text-purple-900">Root Cause</h5>
                                </div>
                                <div class="text-slate-700 text-[13px] leading-relaxed" id="detail-root-cause">-</div>
                            </div>
                            
                            <!-- Fix Suggestion -->
                            <div class="bg-gradient-to-br from-emerald-50 to-emerald-50/30 p-4 rounded-xl border border-emerald-100">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-6 h-6 rounded-md bg-emerald-100 flex items-center justify-center">
                                        <svg class="w-3.5 h-3.5 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h5 class="text-xs font-bold text-emerald-900">Fix Suggestion</h5>
                                </div>
                                <div class="text-slate-700 text-[13px] leading-relaxed" id="detail-solution">-</div>
                            </div>
                        </div>
                        
                        <!-- Raw Data - Collapsible -->
                        <details class="group bg-slate-50 rounded-xl border border-slate-200 overflow-hidden">
                            <summary class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-slate-100 transition-colors">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 rounded-md bg-slate-200 flex items-center justify-center">
                                        <svg class="w-3.5 h-3.5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                                        </svg>
                                    </div>
                                    <span class="text-xs font-bold text-slate-700">Raw Data</span>
                                    <span class="text-[11px] text-slate-400">Stack Trace & Affected Tests</span>
                                </div>
                                <svg class="w-4 h-4 text-slate-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </summary>
                            <div class="px-4 pb-4 space-y-3 border-t border-slate-200 pt-3">
                                <!-- Stack Trace -->
                                <div>
                                    <div class="text-[11px] font-medium text-slate-500 mb-1.5">Representative Stack Trace</div>
                                    <pre class="bg-slate-800 text-slate-200 p-3 rounded-lg text-[11px] font-mono overflow-x-auto whitespace-pre-wrap max-h-56 code-scroll leading-relaxed"
                                        id="detail-stack-trace">-</pre>
                                </div>
                                <!-- Affected Tests -->
                                <div>
                                    <div class="text-[11px] font-medium text-slate-500 mb-1.5">
                                        Affected Test Cases (<span id="detail-failure-count" class="font-bold text-slate-700">0</span>)
                                    </div>
                                    <div class="bg-white border border-slate-200 rounded-lg"
                                        id="detail-failure-list">
                                        <!-- List items -->
                                    </div>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
                <!-- Tab Content: Failures -->
            </div>
            <div id="tab-failures" class="tab-content hidden space-y-4">
                <!-- Search/Filter -->
                <div class="flex gap-4 mb-4">
                    <div class="flex-1 relative">
                        <input type="text" id="failures-search"
                            placeholder="Search failures (module, test case, error)..."
                            class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                            onkeyup="filterFailures()">
                        <svg class="w-5 h-5 text-slate-400 absolute left-3 top-2.5" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <div class="w-48">
                        <select id="failures-group-by" onchange="renderFailuresTable()"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                            <option value="module">Group by Module</option>
                            <option value="cluster">Group by Cluster</option>
                        </select>
                    </div>
                </div>

                <!-- Failures List Container -->
                <div id="failures-list-container" class="space-y-4">
                    <!-- Groups will be injected here -->
                </div>

                <!-- Pagination -->
                <div class="flex items-center justify-between border-t border-slate-200 pt-4">
                    <div class="text-sm text-slate-500">
                        Showing <span id="failures-start" class="font-medium text-slate-900">0</span> to <span
                            id="failures-end" class="font-medium text-slate-900">0</span> of <span id="failures-total"
                            class="font-medium text-slate-900">0</span> modules
                    </div>
                    <div class="flex gap-2">
                        <button id="failures-prev" onclick="changeFailuresPage(-1)"
                            class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Previous
                        </button>
                        <button id="failures-next" onclick="changeFailuresPage(1)"
                            class="px-3 py-1 border border-slate-300 rounded hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
                            Next
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Reset Confirmation Modal -->
        <div id="reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Confirm Reset</h3>
                <div id="reset-modal-message" class="text-sm text-slate-600 mb-6">
                    Are you sure you want to reset all data? This action cannot be undone.
                </div>
                <div class="flex gap-3 justify-end">
                    <button id="reset-modal-cancel"
                        class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                        Cancel
                    </button>
                    <button id="reset-modal-confirm"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Reset System
                    </button>
                </div>
            </div>
        </div>
        <!-- Unlink Confirmation Modal -->
        <div id="unlink-modal" style="z-index: 60;"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold text-slate-800 mb-4">Confirm Unlink</h3>
                <div id="unlink-modal-message" class="text-sm text-slate-600 mb-6"></div>
                <div class="flex gap-3 justify-end">
                    <button id="unlink-modal-cancel"
                        class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                        Cancel
                    </button>
                    <button id="unlink-modal-confirm"
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                        Unlink
                    </button>
                </div>
            </div>
        </div>
        <!-- Redmine Issue Modal -->
        <div id="redmine-modal"
            class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-slate-800">Assign to Redmine</h3>
                    <button onclick="closeRedmineModal()" class="text-slate-400 hover:text-slate-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Tab Selection -->
                <div class="border-b border-slate-200 mb-4">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="switchRedmineTab('link')" id="redmine-tab-link"
                            class="redmine-tab border-blue-500 text-blue-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                            Link Existing Issue
                        </button>
                        <button onclick="switchRedmineTab('create')" id="redmine-tab-create"
                            class="redmine-tab border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm">
                            Create New Issue
                        </button>
                    </nav>
                </div>

                <!-- Link Tab -->
                <div id="redmine-content-link" class="redmine-content">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Search Issues</label>
                            <div class="flex gap-2">
                                <input type="text" id="redmine-search-query" placeholder="Enter keywords..."
                                    class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <button onclick="searchRedmineIssues()"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Search
                                </button>
                            </div>
                        </div>
                        <div id="redmine-search-results"
                            class="max-h-60 overflow-y-auto border border-slate-200 rounded-lg">
                            <div class="p-4 text-center text-slate-500 text-sm">Enter keywords and click Search
                            </div>
                        </div>
                        <button onclick="unlinkRedmineIssue()" id="btn-unlink-issue"
                            class="hidden w-full px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 border border-red-200">
                            Unlink Issue
                        </button>
                    </div>
                </div>

                <!-- Create Tab -->
                <div id="redmine-content-create" class="redmine-content hidden">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Project</label>
                            <select id="redmine-project" onchange="loadRedmineUsers(this.value)"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Loading projects...</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Assignee</label>
                            <select id="redmine-assignee"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Unassigned</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Subject</label>
                            <input type="text" id="redmine-subject" placeholder="Brief description of the issue"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Description</label>
                            <textarea id="redmine-description" rows="6" placeholder="Detailed description..."
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="redmine-create-children"
                                class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500">
                            <label for="redmine-create-children" class="text-sm text-slate-700">Create child issues
                                for
                                individual failures</label>
                        </div>
                        <button onclick="createRedmineIssue(event)"
                            class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            Create Issue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Bulk Create Issues Modal -->
    <div id="bulk-create-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Create Issues for All Clusters</h3>
            
            <div class="space-y-4">
               <div class="bg-blue-50 text-blue-800 p-4 rounded-lg text-sm">
                   <p class="font-medium mb-1">This will create Redmine issues for all unlinked clusters.</p>
                   <p>Settings used:</p>
                    <ul class="list-disc list-inside mt-1 ml-1 space-y-0.5 text-blue-700">
                        <li>Project: <span id="bulk-confirm-project" class="font-semibold">Loading...</span></li>
                        <li>Assignee: <b>Auto-assigned</b> (based on module rules)</li>
                    </ul>
               </div>

                <div id="bulk-create-status" class="hidden mt-2 text-sm"></div>

                <div class="flex gap-3 justify-end">
                    <button onclick="closeBulkCreateModal()" id="btn-cancel-bulk"
                        class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                        Cancel
                    </button>
                    <button onclick="executeBulkCreate()" id="btn-execute-bulk"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors shadow-sm">
                        Confirm & Create
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Template -->
    <template id="tmpl-settings">
        <div class="max-w-2xl mx-auto space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                <h3 class="text-lg font-semibold text-slate-900 mb-6">AI Settings</h3>
                
                <div class="space-y-5">
                    <!-- Apple-style Segmented Control -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-3">AI Provider</label>
                        <div class="segmented-control" role="group">
                            <button type="button" id="seg-openai" onclick="selectProvider('openai')"
                                class="segmented-item active">
                                OpenAI
                            </button>
                            <button type="button" id="seg-internal" onclick="selectProvider('internal')"
                                class="segmented-item">
                                Internal (Ollama/vLLM)
                            </button>
                            <button type="button" id="seg-cambrian" onclick="selectProvider('cambrian')"
                                class="segmented-item">
                                Cambrian
                            </button>
                        </div>
                        <input type="hidden" name="llm-provider" id="provider-openai" value="openai">
                        <input type="hidden" name="llm-provider" id="provider-internal" value="internal">
                        <input type="hidden" name="llm-provider" id="provider-cambrian" value="cambrian">
                    </div>

                    <!-- OpenAI Settings -->
                    <div id="openai-settings" class="space-y-4 pt-4 border-t border-slate-100">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">API Key</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="current-api-key" readonly
                                    class="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg bg-slate-50 text-slate-600 font-mono text-sm"
                                    placeholder="No API key set">
                                <button onclick="toggleAPIKeyVisibility()" id="btn-toggle-key"
                                    class="px-3 py-2 text-sm text-slate-600 border border-slate-200 rounded-lg hover:bg-slate-50 transition-colors">
                                    Show
                                </button>
                                <button onclick="deleteAPIKey()" id="btn-delete-key"
                                    class="px-3 py-2 text-sm text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors">
                                    Delete
                                </button>
                            </div>
                            <p class="mt-1.5 text-xs text-slate-500">Encrypted and stored securely</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Update API Key</label>
                            <div class="flex items-center gap-2">
                                <input type="password" id="new-api-key" placeholder="sk-proj-..."
                                    class="flex-1 px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-slate-50 focus:bg-white">
                                <button onclick="saveAPIKey()" id="btn-save-key"
                                    class="px-4 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors btn-press">
                                    Save Key
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center gap-3 p-3 bg-emerald-50 rounded-xl">
                            <svg class="w-5 h-5 text-emerald-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <p class="text-xs text-emerald-700">Using model: <span class="font-medium">gpt-4o-mini</span></p>
                        </div>
                    </div>

                    <!-- Internal LLM Settings -->
                    <div id="internal-llm-settings" class="hidden space-y-4 pt-4 border-t border-slate-100">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Server URL</label>
                            <input type="text" id="internal-llm-url" placeholder="http://localhost:11434/v1"
                                class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-slate-50 focus:bg-white">
                            <p class="mt-1.5 text-xs text-slate-500">Ollama: http://localhost:11434/v1 | vLLM: http://server:8000/v1</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Model</label>
                            <div class="relative">
                                <select id="internal-llm-model"
                                    class="w-full px-4 py-2.5 pr-10 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-slate-50 focus:bg-white appearance-none cursor-pointer">
                                    <option value="">Select a model...</option>
                                </select>
                                <button type="button" onclick="refreshModelList()" id="btn-refresh-models"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                    title="Refresh model list">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cambrian LLM Settings -->
                    <div id="cambrian-llm-settings" class="hidden space-y-4 pt-4 border-t border-slate-100">
                        <div class="flex items-center gap-3 p-3 bg-amber-50 rounded-xl border border-amber-200">
                            <svg class="w-5 h-5 text-amber-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <p class="text-xs text-amber-700">Cambrian is only accessible from internal network</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">API Token</label>
                            <input type="password" id="cambrian-token" placeholder="Enter your Cambrian API token"
                                class="w-full px-4 py-2.5 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-slate-50 focus:bg-white">
                            <p class="mt-1.5 text-xs text-slate-500">Your token will be encrypted and stored securely</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Model</label>
                            <div class="relative">
                                <select id="cambrian-model"
                                    class="w-full px-4 py-2.5 pr-10 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-slate-50 focus:bg-white appearance-none cursor-pointer">
                                    <option value="LLAMA 3.3 70B">LLAMA 3.3 70B</option>
                                </select>
                                <button type="button" onclick="refreshCambrianModels()" id="btn-refresh-cambrian-models"
                                    class="absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                    title="Refresh model list">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="pt-4 flex items-center gap-3 border-t border-slate-100">
                        <button onclick="saveLLMProvider()" id="btn-save-llm-provider"
                            class="px-5 py-2.5 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm btn-press">
                            Save Settings
                        </button>
                        <button onclick="testLLMConnection()" id="btn-test-llm"
                            class="px-5 py-2.5 border border-slate-200 text-slate-600 text-sm font-medium rounded-lg hover:bg-slate-50 transition-colors flex items-center gap-2 btn-press">
                            <span id="test-icon">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </span>
                            <span id="test-text">Test Connection</span>
                        </button>
                        <span id="llm-provider-status" class="text-sm"></span>
                    </div>
                </div>
            </div>

            <!-- General Settings -->
            <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                <h3 class="text-lg font-semibold text-slate-900 mb-6">General Settings</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Application Base URL</label>
                        <div class="flex items-center gap-2">
                             <input type="text" id="app-base-url" placeholder="http://localhost:8000"
                                class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-slate-50 focus:bg-white transition-colors">
                             <button onclick="saveAppUrl()" id="btn-save-app-url"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium btn-press">
                                Save
                             </button>
                        </div>
                        <p class="mt-1.5 text-xs text-slate-500">
                            The base URL used for generating deep links (e.g., in Redmine tickets). 
                            Set this to your server's IP/domain if deploying (e.g., <code>http://10.0.0.5:8000</code>).
                        </p>
                    </div>
                </div>
            </div>

            <!-- Redmine Integration -->
            <div class="bg-white p-6 rounded-2xl shadow-apple border border-slate-100">
                <h3 class="text-lg font-semibold text-slate-900 mb-6">Redmine Integration</h3>

                <div class="space-y-4">
                    <!-- Current Settings Display -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Redmine URL</label>
                        <input type="text" id="current-redmine-url" readonly
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg bg-slate-50 text-slate-600 text-sm"
                            placeholder="Not configured">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Current API Key</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="current-redmine-key" readonly
                                class="flex-1 px-4 py-2 border border-slate-300 rounded-lg bg-slate-50 text-slate-600 font-mono text-sm"
                                placeholder="No API key set">
                            <button onclick="testRedmineConnection()" id="btn-test-redmine"
                                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors btn-press">
                                Test
                            </button>
                        </div>
                    </div>

                    <!-- Update Settings -->
                    <div class="border-t border-slate-200 pt-4">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Update Redmine URL</label>
                        <input type="text" id="new-redmine-url" placeholder="https://redmine.example.com"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mb-3">

                        <label class="block text-sm font-medium text-slate-700 mb-2">Update API Key</label>
                        <div class="flex items-center gap-2">
                            <input type="password" id="new-redmine-key" placeholder="Enter Redmine API key"
                                class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <button onclick="saveRedmineSettings()" id="btn-save-redmine"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors btn-press">
                                Save
                            </button>
                        </div>
                        <p class="mt-1 text-xs text-slate-500">Enter your Redmine URL and API key. The key will be
                            encrypted.</p>
                    </div>
                </div>
            </div>

            <!-- Module Owner Map Configuration (Collapsible) -->
            <details class="bg-white rounded-2xl shadow-apple border border-slate-100 group">
                <summary class="flex items-center justify-between p-6 cursor-pointer select-none hover:bg-slate-50/50 transition-colors rounded-2xl">
                    <div class="flex items-center gap-3">
                        <svg class="w-4 h-4 text-slate-400 transition-transform duration-200 group-open:rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                        <h3 class="text-lg font-semibold text-slate-900">Module-Owner Assignment</h3>
                        <span class="text-xs font-medium text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">Advanced</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="event.stopPropagation(); resetModuleOwnerMap()" 
                            class="px-3 py-1.5 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg transition-colors btn-press">
                            Reset to Default
                        </button>
                        <button onclick="event.stopPropagation(); saveModuleOwnerMap()" id="btn-save-module-map"
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors btn-press">
                            Save Configuration
                        </button>
                    </div>
                </summary>

                <div class="px-6 pb-6 pt-2">
                <p class="text-sm text-slate-500 mb-4">Configure module-to-team mappings and default settings for Redmine issue creation.</p>

                <div class="space-y-4">
                    <!-- Redmine Data Loader -->
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="text-sm text-slate-600">
                            <span id="redmine-data-status" class="text-slate-400">Redmine data not loaded</span>
                        </div>
                        <button onclick="loadRedmineDropdownData()" id="btn-load-redmine-data"
                            class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Load from Redmine
                        </button>
                    </div>

                    <!-- Target Project & Priority -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Target Project <span class="text-red-500">*</span></label>
                            <select id="default-project-id"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                <option value="">-- Click "Load from Redmine" --</option>
                            </select>
                            <p class="text-xs text-slate-400 mt-1">Issues will be created in this Redmine project</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">Default Priority</label>
                            <select id="default-priority-id"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                                <option value="5">Immediate (5)</option>
                                <option value="4" selected>High (4)</option>
                                <option value="3">Normal (3)</option>
                                <option value="2">Low (2)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Default Assignee -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Default Assignee (Fallback)</label>
                        <select id="default-assignee-id"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white">
                            <option value="">-- Click "Load from Redmine" --</option>
                        </select>
                        <p class="mt-1 text-xs text-slate-500">Used when no module-to-team mapping is found.</p>
                    </div>

                    <!-- Module Pattern Mapping Table -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-slate-700">Module â†’ Owner Mapping</label>
                            <button onclick="addModuleMappingRow()" 
                                class="px-2.5 py-1 text-xs font-medium text-green-600 bg-green-50 hover:bg-green-100 rounded-lg transition-colors flex items-center gap-1">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                Add Rule
                            </button>
                        </div>
                        
                        <div class="border border-slate-200 rounded-lg overflow-hidden">
                            <!-- Table Header -->
                            <div class="grid grid-cols-12 gap-2 p-3 bg-slate-50 border-b border-slate-200 text-xs font-medium text-slate-600">
                                <div class="col-span-5">Module Pattern</div>
                                <div class="col-span-5">Assignee</div>
                                <div class="col-span-2 text-center">Action</div>
                            </div>
                            
                            <!-- Table Body -->
                            <div id="module-mapping-rows" class="divide-y divide-slate-100">
                                <!-- Dynamic rows will be inserted here -->
                                <div class="p-4 text-center text-sm text-slate-400">
                                    Click "Load from Redmine" first, then add mapping rules
                                </div>
                            </div>
                        </div>
                        
                        <p class="mt-2 text-xs text-slate-500">
                            Use glob patterns (e.g., <code class="bg-slate-100 px-1 rounded">CtsMedia*</code>) to match module names. 
                            Assignee dropdown populates after loading Redmine data.
                        </p>
                    </div>

                    <!-- Status Message -->
                    <div id="module-map-status" class="hidden text-sm p-3 rounded-lg"></div>
                </div>
                </div>
            </details>

            <!-- Info Box -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex gap-3">
                    <svg class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-blue-800">
                        <p class="font-medium mb-1">About API Key Storage</p>
                        <ul class="list-disc list-inside space-y-1 text-blue-700">
                            <li>Your API key is encrypted using industry-standard encryption (Fernet)</li>
                            <li>The key is stored securely in the database</li>
                            <li>It will be used automatically for all AI analysis requests</li>
                            <li>You can update or delete it at any time</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </template>



    <template id="tmpl-test-case">
        <div class="max-w-4xl mx-auto space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <!-- Header -->
            <div class="bg-white px-8 py-6 rounded-2xl shadow-apple border border-slate-100 relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-red-500"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Test Case Failure</div>
                        <h3 class="text-xl font-display font-bold text-slate-900 font-mono break-all" id="tc-name">-</h3>
                        <div class="flex items-center gap-3 mt-3">
                            <span class="px-2.5 py-1 rounded text-xs font-medium bg-slate-100 text-slate-600 font-mono" id="tc-module">-</span>
                            <span class="text-slate-300">|</span>
                            <a href="#" id="tc-run-link" class="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                Back to Run #<span id="tc-run-id"></span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div class="bg-red-50 rounded-2xl border border-red-100 p-6">
                <h4 class="text-sm font-bold text-red-900 uppercase tracking-wide mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                    Error Message
                </h4>
                <div class="bg-white/60 p-4 rounded-xl border border-red-100/50 text-red-700 font-mono text-sm whitespace-pre-wrap break-words" id="tc-error"></div>
            </div>

            <!-- Stack Trace -->
            <div class="bg-slate-900 rounded-2xl border border-slate-800 p-6 overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="text-sm font-bold text-slate-400 uppercase tracking-wide flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                        Stack Trace
                    </h4>
                    <button onclick="copyToClipboard(document.getElementById('tc-stack').innerText)" class="text-xs bg-slate-800 text-slate-300 hover:text-white px-3 py-1.5 rounded-lg transition-colors border border-slate-700">
                        Copy
                    </button>
                </div>
                <pre class="text-slate-300 font-mono text-xs overflow-x-auto whitespace-pre-wrap leading-relaxed code-scroll max-h-[600px]" id="tc-stack"></pre>
            </div>
            
             <!-- AI Analysis (If Available) -->
            <div id="tc-analysis-card" class="hidden bg-white rounded-2xl shadow-apple border border-slate-100 p-6">
                 <div class="flex items-center gap-2 mb-4">
                    <div class="p-2 bg-purple-50 text-purple-600 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                    <div>
                        <h4 class="font-bold text-slate-900">AI Analysis</h4>
                        <div class="text-xs text-slate-500">Part of Cluster <a href="#" id="tc-cluster-link" class="text-blue-600 hover:underline">#<span id="tc-cluster-id"></span></a></div>
                    </div>
                 </div>
                 
                 <div class="space-y-4">
                     <div>
                         <div class="text-xs font-bold text-slate-500 uppercase mb-1">Root Cause</div>
                         <div class="text-sm text-slate-700 bg-slate-50 p-3 rounded-lg border border-slate-100" id="tc-root-cause"></div>
                     </div>
                     <div>
                         <div class="text-xs font-bold text-slate-500 uppercase mb-1">Solution</div>
                         <div class="text-sm text-slate-700 bg-slate-50 p-3 rounded-lg border border-slate-100" id="tc-solution"></div>
                     </div>
                 </div>
            </div>
        </div>
    </template>

    <script src="/static/app.js?v=97"></script>
    <!-- Redmine Sync Confirmation Modal -->
    <div id="redmine-sync-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 transition-all duration-300">
        <div class="bg-white rounded-2xl shadow-apple-elevated w-full max-w-md overflow-hidden transform transition-all scale-100 animate-in fade-in zoom-in duration-200">
            <!-- Header -->
            <div class="px-6 py-5 border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-lg font-semibold text-slate-900">Sync to Redmine</h3>
                <p class="text-sm text-slate-500 mt-1">Confirm issue creation details</p>
            </div>
            
            <!-- Body -->
            <div class="px-6 py-6 space-y-4">
                <!-- Redmine URL -->
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Redmine Instance</span>
                    <div class="flex items-center gap-2 text-sm text-slate-700 font-medium">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"></path>
                        </svg>
                        <span id="sync-modal-url">Loading...</span>
                    </div>
                </div>

                <!-- Project -->
                <div class="flex flex-col gap-1">
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Target Project</span>
                    <div class="flex items-center gap-2 text-sm text-slate-700 font-medium">
                        <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        <span id="sync-modal-project">Loading...</span>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm text-blue-800">
                        This action will create <strong id="sync-modal-count" class="font-bold">0</strong> new issue(s) for module <strong id="sync-modal-module" class="font-semibold">Unknown</strong>.
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 bg-slate-50 flex justify-end gap-3 border-t border-slate-100">
                <button id="btn-cancel-sync" class="px-4 py-2 text-sm font-medium text-slate-600 hover:text-slate-800 hover:bg-slate-200 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="btn-confirm-sync" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm hover:shadow transition-all">
                    <span>Create Issues</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <!-- Move Runs Modal Template -->
    <div id="move-runs-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
             <!-- Backdrop -->
            <div class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" 
                 onclick="closeMoveRunsModal()"></div>

            <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-indigo-100 sm:mx-0 sm:h-10 sm:w-10">
                            <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                            </svg>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-base font-semibold leading-6 text-slate-900" id="modal-title">Move Test Runs</h3>
                            <div class="mt-2">
                                <p class="text-sm text-slate-500 mb-4">
                                    You are about to move <span id="move-count-display" class="font-bold text-slate-900">0</span> runs to another submission.
                                </p>
                                
                                <label class="block text-sm font-medium text-slate-700 mb-2">Target Submission</label>
                                <select id="move-target-select" class="block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm py-2.5">
                                    <option value="" disabled selected>Select a target...</option>
                                    <!-- Options injected via JS -->
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" onclick="submitMoveRuns()" class="inline-flex w-full justify-center rounded-xl bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 sm:ml-3 sm:w-auto">Move Runs</button>
                    <button type="button" onclick="closeMoveRunsModal()" class="mt-3 inline-flex w-full justify-center rounded-xl bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto">Cancel</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Cache Buster for app.js -->
    <script>
        const script = document.createElement('script');
        script.src = `/static/app.js?v=${new Date().getTime()}`;
        document.body.appendChild(script);
    </script>
</body>

</html>